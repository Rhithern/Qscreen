[variables]
NIXPACKS_NO_CACHE = '1'
NIXPACKS_METADATA = "node=20,pnpm=latest"
FORCE_REBUILD = "2024-12-31-v9"

[phases.setup]
nixPkgs = ["nodejs_20", "pnpm"]

[phases.install]
cmds = [
  "pnpm install --no-frozen-lockfile --force"
]

[phases.build]
cmds = [
  "pnpm -r --filter \"./frontend\" build",
  "pnpm -r --filter \"./apps/server\" build",
  "rm -rf apps/server/public && mkdir -p apps/server/public",
  "cp -r frontend/dist/* apps/server/public/"
]

[start]
cmd = "node apps/server/dist/index.js"
